# システム開発仕様書: SneakerHeadz Blitz (Ultimate Edition)

**プロジェクト名:** SneakerHeadz Blitz - High Performance Drop Platform
**バージョン:** 2.0 (GCLB + ODB@GCP Edition)
**対象環境:** Google Cloud Tokyo Region & Oracle Database@Google Cloud
**作成日:** 2025年12月12日

-----

## 1\. プロジェクト概要

### 1.1 目的

秒間数万リクエストが集中する限定商品の販売（Drop）イベントにおいて、\*\*「物理レイテンシの最小化（Same Data Center）」**と**「論理レイテンシの最小化（One-Shot Transaction）」\*\*を同時に実現する次世代アーキテクチャを構築し、既存のモダンスタック（Cloudflare + Supabase）と比較検証を行う。

### 1.2 技術的な勝算 (Why Ultimate Blue?)

本プロジェクトでは **"Ultimate Blue Architecture"** を採用する。

  * **Google Scale:** GCLBによる世界最速クラスのCDNとDDoS防御。
  * **Zero Latency:** Googleのデータセンター内に配置されたOracle Exadata (ODB@GCP) への直結。
  * **App Server Less:** ORDSを活用し、中間サーバー（Node.jsコンテナ等）を完全撤廃。
  * **Logic in DB:** MLEにより、ビジネスロジックとデータを同一メモリ空間で処理。

-----

## 2\. アーキテクチャ比較・構成図

### 2.1 比較対象: Red Corner (General Modern Stack)

一般的なサーバーレス/エッジ構成。

  * **App:** Cloudflare Workers (Hono)
  * **DB:** Supabase (Postgres on AWS Tokyo)
  * **課題:**
      * **Cross-Cloud Latency:** Cloudflare(Edge) ⇔ AWS間の物理的距離とインターネット経由のゆらぎ。
      * **Chatty Protocol:** 在庫確認と更新で複数回の往復が発生（ロック期間の増大）。
      * **Connection Limit:** スパイク時のDB接続数枯渇。

### 2.2 採用構成: Blue Corner (Ultimate Architecture)

Google CloudとOracleの強みを統合した構成。

  * **Frontend:** **Google Cloud Load Balancer (GCLB)**
      * Premium Tier Network (Anycast IP)
      * Cloud Armor (WAF/Bot Protection)
      * Cloud CDN (Static/JSON Caching)
      * HTTP/3 (QUIC) Support
  * **Backend:** **ODB@GCP (Autonomous Database Serverless)**
      * 配置: Google Cloud Tokyo Region (VPC Peering/PSC)
      * Interface: **ORDS (Oracle REST Data Services)**
      * Logic: **MLE (JavaScript)**

-----

## 3\. インフラ・ネットワーク仕様

### 3.1 GCLB 設定 (Frontend)

アプリケーションサーバーを介さず、GCLBからADBへ直接トラフィックを流す。

| 項目 | 設定値 | 目的 |
| :--- | :--- | :--- |
| **Protocol** | HTTPS / HTTP/3 (QUIC) | モバイル環境での体感速度向上、ハンドシェイク短縮 |
| **SSL Offload** | GCLB Edgeで終端 | バックエンドへの負荷軽減、高速な接続確立 |
| **Backend Service** | Internet NEG (Network Endpoint Group) | ORDSのエンドポイント(FQDN)へルーティング |
| **Cloud CDN** | 有効 (TTL: 10秒〜) | `GET /search` 等の参照系APIをエッジで即答 |
| **Cloud Armor** | Rate Limiting (100 req/min) | 転売Botの過剰アクセスをDB到達前に遮断 |

### 3.2 ODB@GCP 設定 (Backend)

  * **DB Edition:** Autonomous Transaction Processing (ATP)
  * **Network:** Private Access from Google VPC (低遅延接続)
  * **Connection:** ORDS (HTTPS Port 443)

-----

## 4\. データモデル仕様 (Hybrid Data Model)

JSONの柔軟性とRDBの堅牢性を両立するコンバージド・モデルを採用。

### 4.1 テーブル定義

**1. `SNEAKERS` (商品・在庫)**

  * 頻繁なスキーマ変更（コラボ情報、特殊スペック）に対応するためJSON型を主とする。
  * **重要:** 「サイズごとの在庫数」もJSON内に保持し、MLEでアトミックに操作する。

<!-- end list -->

```sql
CREATE TABLE sneakers (
    id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    data JSON 
    -- { "model": "AJ1", "price": 150, "sizes": {"US9": 10, "US10": 0} }
);
```

**2. `ORDERS` (注文・売上)**

  * 確実な売上管理のため、リレーショナルテーブルとする。

<!-- end list -->

```sql
CREATE TABLE orders (
    id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    sneaker_id NUMBER,
    user_id VARCHAR2(100),
    amount NUMBER,
    ordered_at TIMESTAMP DEFAULT SYSTIMESTAMP
);
```

-----

## 5\. MLEロジック仕様 (JavaScript)

APIサーバー(Node.js)を廃止するため、全てのビジネスロジックをDB内のJSモジュール(`sneaker_logic`)に実装する。

### 5.1 モジュール構成

**Function: `calculatePrice(productData, isPremium)`**

  * **用途:** 検索時のインデックス(FBI)用 兼 購入時の価格確定用 (DRY原則)。
  * **ロジック:**
      * 為替レート換算 (USD -\> JPY)。
      * プレミアム会員かつ非コラボモデルの場合、10%割引。
      * **DETERMINISTIC属性**を付与し、SQLからインデックス化可能にする。

**Function: `purchase(sneakerId, size, userId, isPremium)`**

  * **用途:** 購入トランザクション (One-Shot)。
  * **処理フロー:**
    1.  `SELECT ... FOR UPDATE` で対象行をロック（メモリ内・超高速）。
    2.  JSONパース & 在庫数チェック (`data.sizes[size] > 0`)。
    3.  在庫減算 (メモリ上)。
    4.  `calculatePrice` 再利用による最終価格決定。
    5.  `UPDATE sneakers` (JSON書き戻し)。
    6.  `INSERT INTO orders` (注文確定)。
    7.  コミットして終了。

-----

## 6\. APIインターフェース仕様 (ORDS)

Appサーバーを作らず、PL/SQLでルーティング定義を行うだけでREST APIを公開する。

### 6.1 エンドポイント定義

| Method | Path | Backend Logic | 特徴 |
| :--- | :--- | :--- | :--- |
| **GET** | `/api/search` | SQL Query (FBI活用) | GCLBのCloud CDNでキャッシュ可能。 |
| **POST** | `/api/buy` | Stored Procedure (`buy_kicks`) | BodyのJSONを引数にマッピング。アトミック実行。 |

### 6.2 ORDS定義コード (PL/SQL)

```sql
BEGIN
  -- GET: 検索 (JSONフィルター + 計算済みインデックス)
  ORDS.DEFINE_SERVICE(
    p_module_name => 'sneaker_v1',
    p_base_path   => '/api/',
    p_pattern     => 'search',
    p_method      => 'GET',
    p_source_type => ORDS.source_type_json_collection,
    p_source      => 
      'SELECT id, s.data.model, get_price_js(s.data, :premium) as price 
       FROM sneakers s 
       WHERE get_price_js(s.data, :premium) <= :budget'
  );

  -- POST: 購入 (MLEプロシージャ呼び出し)
  ORDS.DEFINE_SERVICE(
    p_module_name => 'sneaker_v1',
    p_base_path   => '/api/',
    p_pattern     => 'buy',
    p_method      => 'POST',
    p_source_type => ORDS.source_type_plsql,
    p_source      => 'BEGIN buy_kicks(:id, :size, :user, :premium, :status); END;'
  );
  COMMIT;
END;
/
```

-----

## 7\. ベンチマーク・検証計画

Red Corner (Cloudflare + Supabase) と Blue Corner (GCLB + ODB) に対し、負荷試験ツール (k6) から同一条件で攻撃を行い、以下の指標を計測する。

### 7.1 シナリオ: 「The Drop」

  * **条件:** 在庫100足のスニーカーに対し、同時10,000ユーザーが購入リクエストを一斉送信。

### 7.2 計測指標と勝敗ライン

| 指標 | 🟥 Red (Supabase) 予想 | 🟦 Blue (ODB@GCP) 予想 | Blueの勝因 |
| :--- | :--- | :--- | :--- |
| **Over-selling** | 発生する可能性大 | **ゼロ (完全整合)** | 強力な行ロックと単一TX。 |
| **Latency (p95)** | 200ms 〜 500ms | **20ms 〜 50ms** | GCLBのHTTP/3とDB内処理。 |
| **Inventory 0** | 売り切るのに数分かかる | **数秒で完売** | ロック保持時間が極小のため。 |
| **Error Rate** | 接続エラー多発 | **ほぼゼロ** | Cloud ArmorとADBの接続管理。 |

-----

## 8\. 実装ステップ

1.  **GCP/Oracle環境接続:** ODB@GCPのインスタンス払い出しと、GCP VPCとのピアリング設定。
2.  **DB実装:** Liquibaseを使用し `src/database/controller.xml` を適用することで、テーブル・MLEロジック・ORDS定義を一括デプロイ。
3.  **GCLB構築:** Serverless NEGを作成し、ORDSのエンドポイントに向ける。Cloud Armorポリシー適用。
4.  **負荷試験:** k6スクリプトを作成し、世界各国のリージョンから攻撃をシミュレートする。

